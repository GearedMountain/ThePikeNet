{% extends 'base.html' %} {% block content %}
<style>
  #image-container {
    display: flex;
    flex-wrap: wrap;
    max-width: 400px;
    margin: 0 auto;
  }

  #image-container div {
    margin: 2%;
    width: 46%;
    height: 46%;
    object-fit: cover;
  }

  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7); /* slightly opaque black */
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: white;
    font-size: 2em;
    z-index: 5; /* ensure itâ€™s on top */
  }

  #loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 1); /* slightly opaque black */
    display: flex;
    font-size: 2em;
    z-index: 6;
  }

  .no-scroll {
    overflow: hidden;
  }
</style>
<body id="body" class="no-scroll">
  <!--<h1 class="space-mono-bold">Universal Yums</h1>-->
  <div>
    <img
      class="mx-auto max-h-[10vh] mt-2"
      src="{{ url_for('static', filename='images/SnackboxLogo.svg') }}"
    />
    <p class="text-center hidden">User: {{ username }}</p>
    <p id="player-count" class="text-center">0</p>
  </div>
  <button
    id="start-game-button"
    class="mx-auto bg-[#0133a3] text-white block p-2"
    onClick="StartGame()"
  >
    Start Game
  </button>
  <main class="bg-[#0133a3] mt-2">
    <div id="loading-overlay">
      <img
        class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"
        src="{{ url_for('static', filename='images/Loading.gif') }}"
      />
    </div>
    <div id="waiting-overlay" class="overlay">
      Please wait for the game to start
    </div>
    <div class="mx-[400px]" id="image-container"></div>
  </main>
</body>
<script>
  var socket;

  var isAdmin = "{{ isAdmin }}";
  if (isAdmin == "True") {
    isAdmin = true;
    document.getElementById("waiting-overlay").remove();
    document.getElementById("body").classList = "";
  } else {
    isAdmin = false;
    document.getElementById("start-game-button").remove();
  }

  function StartGame() {
    fetch("/snackbox/start-game")
      .then((results) => console.log("Starting game:", results))
      .catch((error) => console.error("Error starting game:", error));
  }

  // Fetch the JSON list of images
  var completedSnacksArray;
  function GetAllSnacks() {
    const allCaptions = [];
    fetch("/snackbox/image-list")
      .then((response) => response.json())
      .then((images) => {
        const container = document.getElementById("image-container");

        // Array of promises for each image load

        const imagePromises = images.map((url, index) => {
          return new Promise((resolve, reject) => {
            const wrapper = document.createElement("div");
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "column";
            wrapper.style.alignItems = "center";
            wrapper.id = `snack:${index}`;

            const img = document.createElement("img");
            img.src = "image/" + url;
            img.alt = "url";

            const fileName = url.split("/").pop() || "";
            const cleaned = fileName
              .replace(/\.(jpg|jpeg|png|gif)$/i, "")
              .replace(/_/g, " ");

            const captionText = cleaned
              .split(" ")
              .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
              .join(" ");

            allCaptions.push(captionText);

            const caption = document.createElement("h3");
            caption.textContent = captionText;
            caption.classList.add("space-mono-bold");
            caption.style.color = "white";
            caption.style.textAlign = "center";
            caption.style.wordBreak = "break-word";

            wrapper.appendChild(img);
            wrapper.appendChild(caption);
            container.appendChild(wrapper);

            img.onload = () => resolve(url);
            img.onerror = () => reject(`Failed to load: ${url}`);
          });
        });

        // Wait for ALL image load promises to complete
        return Promise.allSettled(imagePromises);
      })
      .then((results) => {
        console.log("All images processed:", results);
      })
      .catch((error) => {
        console.error("Error fetching images:", error);
      })
      .finally(() => {
        const overlay = document.getElementById("loading-overlay");
        overlay.style.display = "none";

        socket = io("https://thepikenet.com/snackbox");
        // establish socket only after finished loading
        socket.on("connect", () => {
          console.log("Connected!");
        });

        socket.on("playerlist_update", (data) => {
          const playerList = data.players;
          const playerCountElement = document.getElementById("player-count");
          console.log(`Playerlist: ${playerList}`);
          playerCountElement.innerText = "Players: " + playerList.length;
        });

        socket.on("game-started", (data) => {
          completedSnacksArray = data.completedSnacks;
          console.log("game has sarted: ", data.completedSnacks);
          if (isAdmin) {
            console.log("im an admin");
            const images = document.querySelectorAll("#image-container > div");
            images.forEach((img) => {
              img.onclick = () => {
                alert("Image clicked!");
              };
            });
          } else {
            for (let i = 0; i < completedSnacksArray.length; i++) {
              if (completedSnacksArray[i] == 0) {
                document.getElementById(`snack:${i}`).display = "none";
                document.getElementById("waiting-overlay").display = "none";
              }
            }
          }
        });
      });
  }
  GetAllSnacks();
</script>
{% endblock %}
