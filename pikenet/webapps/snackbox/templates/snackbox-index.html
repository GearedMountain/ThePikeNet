{% extends 'base.html' %} {% block content %}
<style>
  #image-container {
    display: flex;
    flex-wrap: wrap;
    max-width: 400px;
    margin: 0 0;
  }

  #image-container div {
    margin: 2%;
    width: 46%;
    height: 46%;
    object-fit: cover;
  }

  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7); /* slightly opaque black */
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: white;
    font-size: 2em;
    z-index: 5; /* ensure itâ€™s on top */
  }

  #loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 1); /* slightly opaque black */
    display: flex;
    font-size: 2em;
    z-index: 6;
  }

  .no-scroll {
    overflow: hidden;
  }
</style>
<body id="body" class="no-scroll">
  <!--<h1 class="space-mono-bold">Universal Yums</h1>-->
  <div>
    <img
      class="mx-auto max-h-[10vh] mt-2"
      src="{{ url_for('static', filename='images/SnackboxLogo.svg') }}"
    />
    <p class="text-center hidden">User: {{ username }}</p>
    <p id="player-count" class="text-center">0</p>
  </div>
  <button
    id="start-game-button"
    class="mx-auto bg-[#0133a3] text-white block p-2"
    onClick="StartGame()"
  >
    Start Game
  </button>
  <p id="next-snack-available" class="hidden">Select Next Snack</p>
  <div
    id="voting-selector"
    class="flex flex-nowrap gap-4 overflow-x-auto py-2 px-2 hidden"
  ></div>
  <div id="vote-board"></div>
  <main class="bg-[#0133a3]">
    <div id="loading-overlay">
      <img
        class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"
        src="{{ url_for('static', filename='images/Loading.gif') }}"
      />
    </div>
    <div id="waiting-overlay" class="overlay">
      Please wait for the game to start
    </div>
    <div class="text-center space-mono-bold text-[white] bg-[]">
      Completed Snacks:
    </div>
    <div class="mx-[400px] min-h-[10vh]" id="image-container"></div>
  </main>
</body>
<script>
  var socket;

  var isAdmin = "{{ isAdmin }}";
  var selectedSnack = -1;
  if (isAdmin == "True") {
    isAdmin = true;
    document.getElementById("waiting-overlay").remove();
    document.getElementById("body").classList = "";
  } else {
    isAdmin = false;
    document.getElementById("start-game-button").remove();
  }

  function StartGame() {
    fetch("/snackbox/start-game")
      .then((results) => console.log("Starting game:", results))
      .catch((error) => console.error("Error starting game:", error));
  }

  function GameInfoUpdate(completedSnacks) {
    completedSnacksArray = completedSnacks;

    const captions = document.querySelectorAll(".snack-caption");
    const votes = document.querySelectorAll(".your-vote");
    const totals = document.querySelectorAll(".total-score");

    votes.forEach((v) => v.classList.remove("hidden"));
    totals.forEach((t) => t.classList.remove("hidden"));

    castedVotes.forEach((voteValue, index) => {
      if (voteValue !== 0) {
        document.getElementById(
          `yourVote:${index}`
        ).innerText = `Your Vote: ${castedVotes[index]}`;
      }
    });
    if (isAdmin) {
      const images = document.querySelectorAll("#image-container > div");
      document.getElementById("start-game-button").style.display = "none";
      images.forEach((img) => {
        img.onclick = () => {
          const SnackNumber = img.id.split(":")[1];
          fetch("/snackbox/select-snack", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ selectedSnack: SnackNumber }),
          })
            .then((response) => response.text())
            .then((data) => {
              console.log("Server response:", data);
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        };
      });
      for (let i = 0; i < completedSnacksArray.length; i++) {
        document.getElementById(
          `totalScore:${i}`
        ).innerText = `Total Score: ${completedSnacksArray[i]}`;
      }
    } else {
      captions.forEach((c) => c.classList.add("hidden"));

      document.getElementById("waiting-overlay").style.display = "none";
      for (let i = 0; i < completedSnacksArray.length; i++) {
        document.getElementById(
          `totalScore:${i}`
        ).innerText = `Total Score: ${completedSnacksArray[i]}`;
        if (completedSnacksArray[i] == 0) {
          document.getElementById(`snack:${i}`).style.display = "none";
        } else {
          document.getElementById(`snack:${i}`).style.display = "flex";
        }
      }
    }
  }
  // Fetch the JSON list of images
  var completedSnacksArray;
  var castedVotes = [0];
  var snackCount = 0;
  function GetAllSnacks() {
    const allCaptions = [];
    fetch("/snackbox/image-list")
      .then((response) => response.json())
      .then((images) => {
        const container = document.getElementById("image-container");

        // Array of promises for each image load

        const imagePromises = images.map((url, index) => {
          return new Promise((resolve, reject) => {
            snackCount++;
            const wrapper = document.createElement("div");
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "column";
            wrapper.style.alignItems = "center";
            wrapper.id = `snack:${index}`;

            const img = document.createElement("img");
            img.src = "image/" + url;
            img.alt = "url";

            const fileName = url.split("/").pop() || "";
            const cleaned = fileName
              .replace(/\.(jpg|jpeg|png|gif)$/i, "")
              .replace(/_/g, " ");

            const captionText = cleaned
              .split(" ")
              .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
              .join(" ");

            allCaptions.push(captionText);

            const caption = document.createElement("h3");
            caption.textContent = captionText;
            caption.className =
              "snack-caption space-mono-bold text-white text-center";

            // Elements visible ONLY after the game starts
            const yourVote = document.createElement("p");
            yourVote.textContent = "Your Vote: ?";
            yourVote.id = `yourVote:${index}`;
            yourVote.className = "your-vote text-white text-center hidden";

            const totalScore = document.createElement("p");
            totalScore.textContent = "Total Score: ?";
            totalScore.id = `totalScore:${index}`;
            totalScore.className = "total-score text-white text-center hidden";

            wrapper.appendChild(img);
            wrapper.appendChild(caption);
            wrapper.appendChild(yourVote);
            wrapper.appendChild(totalScore);
            container.appendChild(wrapper);

            img.onload = () => resolve(url);
            img.onerror = () => reject(`Failed to load: ${url}`);
          });
        });

        // Wait for ALL image load promises to complete

        return Promise.allSettled(imagePromises);
      })
      .then((results) => {
        console.log("All images processed:", results);
        for (let i = 1; i <= snackCount; i++) {
          const container = document.getElementById("voting-selector");

          const box = document.createElement("div");
          box.className =
            "flex justify-center items-center bg-[#0133a3] text-white font-bold shrink-0";
          box.style.width = "10vw";
          box.style.height = "10vw";
          box.id = `vote:${i}`;
          box.textContent = i;
          box.onclick = () => {
            console.log("Box clicked:", i); // replace with your action
            if (isAdmin) {
              document
                .getElementById("next-snack-available")
                .classList.add("hidden");
            }
            document.getElementById(
              `yourVote:${selectedSnack}`
            ).innerText = `Your Vote: ${i}`;
            // Example: send number to backend via fetch
            fetch("/snackbox/cast-vote", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ voteValue: i }),
            })
              .then((res) => res.text())
              .then((data) => console.log("Server response:", data));
          };
          container.appendChild(box);
        }
      })
      .catch((error) => {
        console.error("Error fetching images:", error);
      })
      .finally(() => {
        const overlay = document.getElementById("loading-overlay");
        overlay.style.display = "none";

        socket = io("https://thepikenet.com/snackbox");
        // establish socket only after finished loading
        socket.on("connect", () => {
          console.log("Connected!");
        });

        socket.on("playerlist_update", (data) => {
          const playerList = data.players;
          const playerCountElement = document.getElementById("player-count");
          console.log(`Playerlist: ${playerList}`);
          playerCountElement.innerText = "Players: " + playerList.length;
        });

        socket.on("snack-selected", (data) => {
          selectedSnack = data.currentVote;
          document.getElementById("voting-selector").classList.remove("hidden");
          document.getElementById("vote-board").innerHTML = "";
        });

        socket.on("game-started", (data) => {
          GameInfoUpdate(data.completedSnacks);
        });

        socket.on("game-update", (data) => {
          GameInfoUpdate(data.completedSnacks);
        });

        socket.on("somebody-voted", (data) => {
          const voteBoard = document.getElementById("vote-board");
          const vote = document.createElement("p");
          vote.textContent = data.voteCasted;
          voteBoard.appen(vote);
        });

        socket.on("everybody-voted", (data) => {
          if (isAdmin) {
            document
              .getElementById("next-snack-available")
              .classList.remove("hidden");
          }
        });

        socket.on("update-remaining-votes", (data) => {
          const allBoxes = document.querySelectorAll('[id^="vote:"]');
          allBoxes.forEach((box) => {
            const voteNumber = parseInt(box.id.split(":")[1], 10);

            // Hide if voteNumber is NOT in remainingVotes
            if (!data.remainingVotes.includes(voteNumber)) {
              box.style.display = "none";
            }

            castedVotes = data.castedVotes;
            GameInfoUpdate(completedSnacksArray);
          });
          if (!data.canVote) {
            document.getElementById("voting-selector").classList.add("hidden");
          } else {
            document
              .getElementById("voting-selector")
              .classList.remove("hidden");
          }
        });
      });
  }
  GetAllSnacks();
</script>
{% endblock %}
